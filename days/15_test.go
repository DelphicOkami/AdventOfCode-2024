package days_test

import (
	"aoc/days"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/suite"
)

type FifteenSuite struct {
	suite.Suite
	ProvidedInputLarge []string
	ProvidedInputSmall []string
}

func TestRunFifteenSuite(t *testing.T) {
	suite.Run(t, new(FifteenSuite))
}

func (suite *FifteenSuite) SetupTest() {
	suite.ProvidedInputLarge = []string{"##########", "#..O..O.O#", "#......O.#", "#.OO..O.O#", "#..O@..O.#", "#O#..O...#", "#O..O..O.#", "#.OO.O.OO#", "#....O...#", "##########", "", "<vv>^<v^>v>^vv^v>v<>v^v<v<^vv<<<^><<><>>v<vvv<>^v^>^<<<><<v<<<v^vv^v>^", "vvv<<^>^v^^><<>>><>^<<><^vv^^<>vvv<>><^^v>^>vv<>v<<<<v<^v>^<^^>>>^<v<v", "><>vv>v^v^<>><>>>><^^>vv>v<^^^>>v^v^<^^>v^^>v^<^v>v<>>v^v^<v>v^^<^^vv<", "<<v<^>>^^^^>>>v^<>vvv^><v<<<>^^^vv^<vvv>^>v<^^^^v<>^>vvvv><>>v^<<^^^^^", "^><^><>>><>^^<<^^v>>><^<v>^<vv>>v>>>^v><>^v><<<<v>>v<v<v>vvv>^<><<>^><", "^>><>^v<><^vvv<^^<><v<<<<<><^v<<<><<<^^<v<^^^><^>>^<v^><<<^>>^v<v^v<v^", ">^>>^v>vv>^<<^v<>><<><<v<<v><>v<^vv<<<>^^v^>^^>>><<^v>>v^v><^^>>^<>vv^", "<><^^>^^^<><vvvvv^v<v<<>^v<v>v<<^><<><<><<<^^<<<^<<>><<><^^^>^^<>^>v<>", "^^>vv<^v^v<vv>^<><v<^v>^^^>>>^^vvv^>vvv<>>>^<^>>>>>^<<^v>^vvv<>^<><<v>", "v^^>>><<^^<>>^v^<v^vv<>v^<<>^<^v^v><^<<<><<^<v><v<>vv>>v><v^<vv<>v^<<^"}
	suite.ProvidedInputSmall = []string{"########", "#..O.O.#", "##@.O..#", "#...O..#", "#.#.O..#", "#...O..#", "#......#", "########", "", "<^^>>>vv<v>>v<<"}
}

func (suite *FifteenSuite) TestOneCasesPresented() {
	assert.Equal(suite.T(), 10092, days.DayFifteenPart1(suite.ProvidedInputLarge))
}

func (suite *FifteenSuite) TestTwoCasesPresented() {
	assert.Equal(suite.T(), 9021, days.DayFifteenPart2(suite.ProvidedInputLarge))
	shouldBe := [][]rune{
		{'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'},
		{'#', '#', '[', ']', '.', '.', '[', ']', '.', '.', '.', '.', '[', ']', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '[', ']', '.', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '[', ']', '.', '#', '#'},
		{'#', '#', '[', ']', '[', ']', '[', ']', '.', '.', '.', '.', '.', '.', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '[', ']', '.', '[', ']', '.', '.', '.', '.', '.', '[', ']', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '[', ']', '#', '#', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '#', '#'},
		{'#', '#', '[', ']', '.', '.', '.', '.', '.', '.', '.', '.', '.', '@', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '.', '#', '#'},
		{'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'},
	}
	w := days.FifteenParseInput(suite.ProvidedInputLarge)
	wt := w.EnThicken()
	wt.Grid = shouldBe
	wt.Robot = days.Coords{Y: 6, X: 13}
	wt.Directions = []rune{'^'}
	boxL, boxR := wt.GetBox(days.Coords{X: 12, Y: 1})
	assert.Equal(suite.T(), days.Coords{X: 12, Y: 1}, boxL)
	assert.Equal(suite.T(), days.Coords{X: 13, Y: 1}, boxR)
	boxL, boxR = wt.GetBox(days.Coords{X: 13, Y: 1})
	assert.Equal(suite.T(), days.Coords{X: 12, Y: 1}, boxL)
	assert.Equal(suite.T(), days.Coords{X: 13, Y: 1}, boxR)
	boxL, boxR = wt.GetBox(days.Coords{X: 14, Y: 1})
	assert.Equal(suite.T(), days.Coords{X: 14, Y: 1}, boxL)
	assert.Equal(suite.T(), days.Coords{X: 15, Y: 1}, boxR)
	boxL, boxR = wt.GetBox(days.Coords{X: 15, Y: 1})
	assert.Equal(suite.T(), days.Coords{X: 14, Y: 1}, boxL)
	assert.Equal(suite.T(), days.Coords{X: 15, Y: 1}, boxR)
	boxL, boxR = wt.GetBox(days.Coords{X: 13, Y: 2})
	assert.Equal(suite.T(), days.Coords{X: 13, Y: 2}, boxL)
	assert.Equal(suite.T(), days.Coords{X: 14, Y: 2}, boxR)
	boxL, boxR = wt.GetBox(days.Coords{X: 14, Y: 2})
	assert.Equal(suite.T(), days.Coords{X: 13, Y: 2}, boxL)
	assert.Equal(suite.T(), days.Coords{X: 14, Y: 2}, boxR)
	assert.False(suite.T(), wt.CanMoveBox(days.Coords{X: 12, Y: 1}, 0, -1))
	assert.True(suite.T(), wt.CanMoveBox(days.Coords{X: 12, Y: 4}, 0, -1))
	assert.True(suite.T(), wt.CanMoveBox(days.Coords{X: 12, Y: 5}, 0, -1))
	wt.FollowMoveSequence()
	wt.Render()
	shouldBe = [][]rune{
		{'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'},
		{'#', '#', '[', ']', '.', '.', '[', ']', '.', '.', '.', '.', '[', ']', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '[', ']', '.', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '[', ']', '.', '#', '#'},
		{'#', '#', '[', ']', '[', ']', '[', ']', '.', '.', '.', '.', '[', ']', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '[', ']', '.', '[', ']', '.', '.', '.', '.', '.', '[', ']', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '[', ']', '#', '#', '.', '.', '.', '.', '.', '.', '.', '@', '.', '.', '.', '.', '#', '#'},
		{'#', '#', '[', ']', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '.', '#', '#'},
		{'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'},
	}
	assert.Equal(suite.T(), shouldBe, wt.Grid)
}

func (suite *FifteenSuite) TestParse() {
	expected := days.FifteenWarehouse{
		Chizu: days.Chizu{
			Grid: [][]rune{
				{'#', '#', '#', '#', '#', '#', '#', '#'},
				{'#', '.', '.', 'O', '.', 'O', '.', '#'},
				{'#', '#', '@', '.', 'O', '.', '.', '#'},
				{'#', '.', '.', '.', 'O', '.', '.', '#'},
				{'#', '.', '#', '.', 'O', '.', '.', '#'},
				{'#', '.', '.', '.', 'O', '.', '.', '#'},
				{'#', '.', '.', '.', '.', '.', '.', '#'},
				{'#', '#', '#', '#', '#', '#', '#', '#'},
			},
		},
		Robot:      days.Coords{X: 2, Y: 2},
		Directions: []rune{'<', '^', '^', '>', '>', '>', 'v', 'v', '<', 'v', '>', '>', 'v', '<', '<'},
	}

	assert.Equal(suite.T(), expected, days.FifteenParseInput(suite.ProvidedInputSmall))

	enthickened := [][]rune{
		{'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '.', '.', '[', ']', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '[', ']', '@', '.', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '[', ']', '#', '#', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '.', '.', '#', '#'},
		{'#', '#', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '.', '.', '[', ']', '[', ']', '.', '.', '[', ']', '.', '.', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '.', '.', '#', '#'},
		{'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'},
	}
	w := days.FifteenParseInput(suite.ProvidedInputLarge)
	wt := w.EnThicken()

	assert.Equal(suite.T(), enthickened, wt.Chizu.Grid)
	assert.Equal(suite.T(), days.Coords{X: 8, Y: 4}, wt.Robot)
	r, _ := wt.Chizu.GetRuneFromCoords(wt.Robot)
	assert.Equal(suite.T(), '@', r)
}

func (suite *FifteenSuite) TestMoveRobot() {
	up := [][]rune{
		{'#', '#', '#', '#', '#', '#', '#', '#'},
		{'#', '.', '@', 'O', '.', 'O', '.', '#'},
		{'#', '#', '.', '.', 'O', '.', '.', '#'},
		{'#', '.', '.', '.', 'O', '.', '.', '#'},
		{'#', '.', '#', '.', 'O', '.', '.', '#'},
		{'#', '.', '.', '.', 'O', '.', '.', '#'},
		{'#', '.', '.', '.', '.', '.', '.', '#'},
		{'#', '#', '#', '#', '#', '#', '#', '#'},
	}
	upRight := [][]rune{
		{'#', '#', '#', '#', '#', '#', '#', '#'},
		{'#', '.', '.', '@', 'O', 'O', '.', '#'},
		{'#', '#', '.', '.', 'O', '.', '.', '#'},
		{'#', '.', '.', '.', 'O', '.', '.', '#'},
		{'#', '.', '#', '.', 'O', '.', '.', '#'},
		{'#', '.', '.', '.', 'O', '.', '.', '#'},
		{'#', '.', '.', '.', '.', '.', '.', '#'},
		{'#', '#', '#', '#', '#', '#', '#', '#'},
	}
	upRightRight := [][]rune{
		{'#', '#', '#', '#', '#', '#', '#', '#'},
		{'#', '.', '.', '.', '@', 'O', 'O', '#'},
		{'#', '#', '.', '.', 'O', '.', '.', '#'},
		{'#', '.', '.', '.', 'O', '.', '.', '#'},
		{'#', '.', '#', '.', 'O', '.', '.', '#'},
		{'#', '.', '.', '.', 'O', '.', '.', '#'},
		{'#', '.', '.', '.', '.', '.', '.', '#'},
		{'#', '#', '#', '#', '#', '#', '#', '#'},
	}
	warehouse := days.FifteenParseInput(suite.ProvidedInputSmall)
	warehouse.MoveRobot(0, -1)
	assert.Equal(suite.T(), up, warehouse.Chizu.Grid)
	warehouse.MoveRobot(1, 0)
	assert.Equal(suite.T(), upRight, warehouse.Chizu.Grid)
	warehouse.MoveRobot(1, 0)
	assert.Equal(suite.T(), upRightRight, warehouse.Chizu.Grid)
	warehouse.MoveRobot(1, 0)
	assert.Equal(suite.T(), upRightRight, warehouse.Chizu.Grid)
}

func (suite *FifteenSuite) TestMoveSeq() {
	upRightRight := [][]rune{
		{'#', '#', '#', '#', '#', '#', '#', '#'},
		{'#', '.', '.', '.', '@', 'O', 'O', '#'},
		{'#', '#', '.', '.', 'O', '.', '.', '#'},
		{'#', '.', '.', '.', 'O', '.', '.', '#'},
		{'#', '.', '#', '.', 'O', '.', '.', '#'},
		{'#', '.', '.', '.', 'O', '.', '.', '#'},
		{'#', '.', '.', '.', '.', '.', '.', '#'},
		{'#', '#', '#', '#', '#', '#', '#', '#'},
	}
	warehouse := days.FifteenParseInput(suite.ProvidedInputSmall)
	warehouse.Directions = []rune{'^', '>', '>', '>'}
	warehouse.FollowMoveSequence()
	assert.Equal(suite.T(), upRightRight, warehouse.Chizu.Grid)
}

func (suite *FifteenSuite) TestThiccMove() {
	postMove := [][]rune{
		{'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '.', '.', '[', ']', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '[', ']', '@', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '[', ']', '#', '#', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '.', '.', '#', '#'},
		{'#', '#', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '.', '.', '[', ']', '[', ']', '.', '.', '[', ']', '.', '.', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '.', '.', '#', '#'},
		{'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'},
	}
	w := days.FifteenParseInput(suite.ProvidedInputLarge)
	wt := w.EnThicken()
	wt.MoveRobot(-1, 0)
	assert.Equal(suite.T(), postMove, wt.Chizu.Grid)

	postMove = [][]rune{
		{'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '.', '.', '[', ']', '@', '.', '.', '.', '.', '.', '[', ']', '.', '.', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '[', ']', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '[', ']', '#', '#', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '.', '.', '#', '#'},
		{'#', '#', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '.', '.', '[', ']', '[', ']', '.', '.', '[', ']', '.', '.', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '.', '.', '#', '#'},
		{'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'},
	}
	wt.Directions = []rune{'v', 'v'}
	wt.Chizu.Grid = [][]rune{
		{'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '.', '.', '[', ']', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '[', ']', '@', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '[', ']', '#', '#', '.', '[', ']', '.', '[', ']', '.', '.', '.', '.', '.', '.', '#', '#'},
		{'#', '#', '[', ']', '.', '.', '[', ']', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '.', '.', '[', ']', '[', ']', '.', '.', '.', '.', '.', '.', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '.', '.', '#', '#'},
		{'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'},
	}
	postMoveMap := days.Chizu{Grid: [][]rune{
		{'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '.', '.', '[', ']', '[', ']', '.', '.', '.', '.', '[', ']', '.', '.', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '[', ']', '.', '.', '.', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '[', ']', '#', '#', '.', '@', '.', '.', '[', ']', '.', '.', '.', '.', '.', '.', '#', '#'},
		{'#', '#', '[', ']', '.', '.', '.', '[', ']', '.', '.', '.', '.', '.', '[', ']', '.', '.', '#', '#'},
		{'#', '#', '.', '.', '[', ']', '[', ']', '[', ']', '.', '.', '.', '.', '[', ']', '[', ']', '#', '#'},
		{'#', '#', '.', '.', '.', '.', '[', ']', '.', '.', '[', ']', '.', '.', '.', '.', '.', '.', '#', '#'},
		{'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'},
	}}
	wt.FollowMoveSequence()
	assert.Equal(suite.T(), postMoveMap.Grid, wt.Chizu.Grid)
}
